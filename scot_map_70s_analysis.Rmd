---
title: "Mapping rate of over 70s at Datazone level in Scotland"
author: "David Henderson"
date: "27/03/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Intro

Map proportion of over 70s and over 80s in rach datazone in Scotland

## Packages

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(sf)
library(viridis)
theme_set(theme_minimal(base_family = "Roboto", base_size = 16) +
            theme(panel.grid.minor = element_blank()))

colours_davidhen <- c("#e53935", "#3949ab", "#8e24aa", "#039be5",
                      "#00897b", "#7cb342", "#fdd835", "#fb8c00",
                      "#6d4c41", "#546e7a")
```


## Load Data

### Population data

Popoulation data comes from NRS Estimated population by sex, single year of age, 2011 Data Zone area, and council area: 30 June 2018 found on [this web page](https://www.nrscotland.gov.uk/statistics-and-data/statistics/statistics-by-theme/population/population-estimates/2011-based-special-area-population-estimates/small-area-population-estimates/time-series#2018) and specifically at [this link](https://www.nrscotland.gov.uk/files//statistics/population-estimates/sape-time-series/persons/sape-2018-persons.csv). There are issues with filepaths trying to load the csv in directly using `read_csv()` which I suspect is a Mac/Windows issue. For speed I have downloaded the file into the 'data' folder and load it in here skipping the first 3 lines which are superfluous. 

```{r, message=FALSE, warning=FALSE}
pop_data <- read_csv(here::here("data/sape-2018-persons.csv"), 
                     skip = 3)
pop_data
```

### Shapefile data

I have also downlaoded the shapefile data as it is large and zipped. I used [data.gov.uk](https://data.gov.uk/dataset/ab9f1f20-3b7f-4efa-9bd2-239acf63b540/data-zone-boundaries-2011) as the source. 

```{r, message=FALSE, warning=FALSE, fig.width=9, fig.height=12}
shp_dz <- st_read(here::here("data/SG_DataZoneBdry_2011/SG_DataZone_Bdry_2011.shp"))
shp_dz %>% 
  select(DataZone, Name, geometry) %>% 
  ggplot() +
  geom_sf() +
  theme(line = element_blank(),
        axis.text = element_blank(),
        panel.grid = element_line(colour = "transparent"),
        plot.caption = element_text(size = 10, colour = "#AAAAAA")) 
```


```{r, fig.width=12, fig.height=9}
shp_dz %>% 
  select(DataZone, Name, geometry) %>% 
  rename(dz_code = DataZone,
         dz_name = Name) %>% 
  left_join(., pop_data) %>% 
  filter(dz_council == "City of Edinburgh") %>% 
  ggplot(aes(fill = over_70*100)) +
  geom_sf(alpha = 0.8,
          colour = 'white',
          size = 0.3) +
  scale_fill_viridis(discrete = F,
                     name = "Over 70 (%)",
                     direction = -1,
                     guide = guide_colourbar(
                       direction = "horizontal",
                       barheight = unit(5, units = "mm"),
                       barwidth = unit(100, units = "mm"),
                       title.position = 'top',
                       title.hjust = 0.5,
                       label.hjust = 0.5)) +
  theme(line = element_blank(),
        axis.text = element_blank(),
        panel.grid = element_line(colour = "transparent"),
        plot.caption = element_text(size = 10, colour = "#AAAAAA"),
        legend.position = c(0.6, 0.1)) 
  
```


# Tidy data

## Population Data

```{r}
pop_data %<>% 
  #drop empty 2nd row
  slice(3:length(X1)) %>% 
  select(-X5, -c(AGE0:AGE69)) %>% 
  rename(dz_code = X1,
         dz_name = X2,
         dz_council = X3,
         pop_total = X4) %>% 
  mutate(pop_70plus = rowSums(.[5:25]),
         pop_80plus = rowSums(.[15:25]),
         over_70 = pop_70plus/pop_total,
         over_80 = pop_80plus/pop_total) %>%
  select(dz_code, dz_name, dz_council, pop_total, 
         over_70, over_80)
pop_data
```

```{r}
pop_data %>% 
  pivot_longer(cols = c(over_70, over_80), 
               names_to = "category",
               values_to = "frequency") %>% 
  ggplot() +
  geom_histogram(aes(frequency, fill = category), 
                 bins  = 35, alpha = 0.5) +
  scale_x_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = c("#e53935", "#3949ab"), 
                    labels = c("Over 70", "Over 80")) +
  theme(legend.position = "bottom") +
  labs(title = "Number of datazones with specified percentages of\nover 70s and 80s",
       x = "",
       y = "Number of datazones",
       fill = "Age category")
```

```{r}
describe(pop_data$over_70*100, IQR = TRUE, quant = c(.25,.75))
```



## Shapefile data

# Plot
